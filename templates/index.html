<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🤖 Asistente IA de Trading</title>

<style>
  :root {
    --bg: #0d1117;
    --card: #161b22;
    --text: #e6edf3;
    --muted: #8b949e;
    --primary: #58a6ff;
    --green: #00ff88;
    --red: #ff4d4d;
    --yellow: #f1c40f;
  }
  body {
    font-family: 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    transition: background 0.8s ease;
  }
  header { text-align: center; padding: 30px 10px; }
  h1 { color: var(--primary); margin-bottom: 10px; }
  .subtitle { color: var(--muted); }
  .search {
    display: flex; justify-content: center; gap: 8px; padding: 15px; flex-wrap: wrap;
  }
  #symbol-input {
    padding: 12px; font-size: 16px; border-radius: 8px;
    border: 1px solid #2f3136; background: var(--card); color: var(--text); width: 260px;
  }
  button {
    padding: 12px 18px; font-size: 16px; cursor: pointer;
    background: var(--primary); color: #fff; border: none; border-radius: 8px;
  }
  #respuesta-consulta {
    display: none;
    max-width: 640px;
    background: var(--card);
    margin: 20px auto;
    padding: 20px;
    border-radius: 10px;
    line-height: 1.6;
  }
  .alert-buy { border-left: 5px solid var(--green); background: #11331e; }
  .alert-sell { border-left: 5px solid var(--red); background: #3b1111; }
  .alert-news { border-left: 5px solid var(--yellow); background: #2f2f15; }
  .alert-strat { border-left: 5px solid var(--primary); background: #1d2634; }
  .rr-high { color: var(--green); font-weight: bold; }
  .rr-medium { color: var(--yellow); font-weight: bold; }
  .rr-low { color: var(--red); font-weight: bold; }
  .news-block {
    margin-top: 12px;
    padding: 12px;
    background: #2f2f15;
    border-left: 4px solid var(--yellow);
    border-radius: 8px;
  }
  /* Scanner */
  #scanner-result {
    margin-top: 15px;
  }
  .scanner-card {
    margin-bottom: 15px;
    padding: 15px;
    background: #1d2634;
    border-radius: 8px;
  }
</style>
</head>

<body>
  <!-- 🔔 Sonido de alerta -->
  <audio id="alert-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_37c775d6cf.mp3?filename=notification-5-138258.mp3" preload="auto"></audio>

  <header>
    <h1>👋 Asistente IA de Trading</h1>
    <p class="subtitle">Analiza cualquier símbolo de Binance Futures con cerebro híbrido IA + FIB/ATR 🧠</p>
    <div class="search">
      <input id="symbol-input" type="text" placeholder="Ej: BTCUSDT" />
      <button onclick="consultarSimbolo()">Analizar</button>
    </div>
  </header>

  <main>
    <!-- 🔸 Resultado de análisis individual -->
    <section id="respuesta-consulta"></section>

    <!-- 🔸 Scanner Top 3 Oportunidades -->
    <section style="max-width:800px;margin:40px auto;padding:20px;background:#161b22;border-radius:10px;">
      <h2>📊 Top 3 Oportunidades</h2>
      <p style="color:var(--muted);font-size:14px;margin-top:5px;">
        🔁 El escaneo se realiza automáticamente al cerrar cada vela de 1 hora.
      </p>
      <button onclick="cargarScanner()">📡 Escanear manualmente</button>
      <p id="last-update" style="color: var(--muted); font-size: 14px; margin-top: 10px;"></p>
      <div id="scanner-result"></div>
    </section>
  </main>

  <footer style="text-align:center;color:#666;padding:30px 0;">
    © 2025 Trading IA Pro — Señales Inteligentes 📈
  </footer>

<script>
let ultimoTop3 = null; // 🧠 Guardamos la última lectura

// 📌 Análisis individual
async function consultarSimbolo() {
  const symbol = document.getElementById("symbol-input").value.trim().toUpperCase();
  const box = document.getElementById("respuesta-consulta");
  box.style.display = "block";
  box.className = "alert-strat";
  box.innerHTML = "⏳ Analizando " + (symbol || "—") + "...";

  if (!symbol) {
    box.innerHTML = "⚠️ Por favor, ingresa un símbolo válido.";
    return;
  }

  try {
    const res = await fetch("/api/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ symbol })
    });
    const data = await res.json();

    if (data.error) {
      box.className = "alert-news";
      box.innerHTML = "❌ " + data.error;
      return;
    }

    if (data.signal?.includes("COMPRA")) {
      box.className = "alert-buy";
      document.body.style.background = "#002b14";
    } else if (data.signal?.includes("VENTA")) {
      box.className = "alert-sell";
      document.body.style.background = "#300000";
    } else {
      box.className = "alert-news";
      document.body.style.background = "#2f2f15";
    }

    let html = `
      <h2>${data.symbol || "—"}</h2>
      <p>📈 Señal: <strong>${data.signal || "—"}</strong></p>
      ${num(data.prob_up) ? `<p>🔼 Prob ↑: ${data.prob_up}%</p>` : ""}
      ${num(data.prob_down) ? `<p>🔽 Prob ↓: ${data.prob_down}%</p>` : ""}
      ${num(data.price) ? `<p>💰 Precio actual: ${fmt(data.price)}</p>` : ""}
    `;

    if (data.entry_suggest) html += `<p>🎯 <strong>Entrada sugerida:</strong> ${fmt(data.entry_suggest)}</p>`;
    if (data.SL) html += `<p>🛑 <strong>Stop Loss:</strong> ${fmt(data.SL)}</p>`;
    if (data.TP) html += `<p>🏁 <strong>Take Profit:</strong> ${fmt(data.TP)}</p>`;
    if (data.risk_rr) {
      const rrClass = data.risk_rr >= 2 ? "rr-high" : data.risk_rr >= 1 ? "rr-medium" : "rr-low";
      let rrText = data.risk_rr >= 2
        ? "🟢 Alta calidad — trade favorable ✅"
        : data.risk_rr >= 1
        ? "🟡 Media calidad — operar con precaución ⚠️"
        : "🔴 Baja calidad — evitar entrada 🚫";
      html += `<p>⚖️ R:R: <span class="${rrClass}">${data.risk_rr}</span><br>${rrText}</p>`;
    }
    if (data.plan) html += `<p>🧭 Plan de trade: ${data.plan}</p>`;
    if (data.narrative) html += `<p>📝 ${escapeHTML(data.narrative)}</p>`;

    if (data.news_event) {
      const ev = data.news_event;
      html += `
        <div class="news-block">
          <strong>🚨 Noticia próxima</strong><br/>
          📢 ${escapeHTML(ev.event || "Evento económico")}<br/>
          🌍 ${escapeHTML(ev.country || "—")}<br/>
          🕒 ${escapeHTML(ev.time || "—")}
        </div>`;
    } else {
      html += `<div class="news-block" style="opacity:0.8;">
        📡 No existen noticias relevantes en los próximos minutos.
      </div>`;
    }

    box.innerHTML = html;
  } catch (err) {
    box.className = "alert-news";
    box.innerHTML = "❌ Error de red: " + err.message;
  }
}

// 📊 Scanner Top 3
async function cargarScanner() {
  const box = document.getElementById("scanner-result");
  box.innerHTML = "⏳ Escaneando mercado...";

  try {
    const res = await fetch("/api/scanner");
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      box.innerHTML = "⚠️ No hay oportunidades activas en este momento.";
      ultimoTop3 = null;
      return;
    }

    const cambio = hayCambioTop3(ultimoTop3, data);
    ultimoTop3 = data;

    let html = "";
    data.forEach((op, i) => {
      const rrClass = op.risk_rr >= 2 ? "rr-high" : op.risk_rr >= 1 ? "rr-medium" : "rr-low";
      html += `
        <div class="scanner-card" style="border-left:5px solid ${op.signal.includes('VENTA') ? 'var(--red)' : 'var(--green)'};">
          <h3>${i+1}️⃣ ${op.symbol}</h3>
          <p><strong>${op.signal}</strong></p>
          <p>📈 Prob ↑: ${op.prob_up}% | 📉 Prob ↓: ${op.prob_down}%</p>
          <p>💰 Precio actual: ${fmt(op.price)}</p>
          <p>🎯 Entrada: ${fmt(op.entry_suggest)} | 🛑 SL: ${fmt(op.SL)} | 🏁 TP: ${fmt(op.TP)}</p>
          <p>⚖️ R:R: <span class="${rrClass}">${op.risk_rr}</span></p>
          <p>🧭 Plan: ${op.plan}</p>
        </div>
      `;
    });

    box.innerHTML = html;
    document.getElementById("last-update").innerText =
      "⏰ Última actualización: " + new Date().toLocaleTimeString();

    if (cambio) lanzarAlerta();
  } catch (err) {
    box.innerHTML = "❌ Error al escanear mercado: " + err.message;
  }
}

// 🧠 Detectar cambios en Top 3
function hayCambioTop3(anterior, actual) {
  if (!anterior || !Array.isArray(anterior)) return true;
  if (anterior.length !== actual.length) return true;

  for (let i = 0; i < actual.length; i++) {
    if (anterior[i].symbol !== actual[i].symbol ||
        anterior[i].signal !== actual[i].signal) {
      return true;
    }
  }
  return false;
}

// 🔔 Lanzar alerta
function lanzarAlerta() {
  console.log("🔔 ¡Cambio detectado en el Top 3!");
  const sonido = document.getElementById("alert-sound");
  sonido.currentTime = 0;
  sonido.play().catch(() => {});
  document.title = "⚡ NUEVA SEÑAL DETECTADA ⚡";
  setTimeout(() => { document.title = "🤖 Asistente IA de Trading"; }, 5000);

  if (Notification.permission === "granted") {
    new Notification("🚀 Nueva señal detectada", {
      body: "Hay cambios en el Top 3 de oportunidades",
      icon: "https://cdn-icons-png.flaticon.com/512/2721/2721291.png"
    });
  }
}

// 🕒 Escanear al cierre de vela (cada hora exacta)
function iniciarScannerPorVela() {
  const ahora = new Date();
  const minutos = ahora.getMinutes();
  const segundos = ahora.getSeconds();
  const msRestantes = ((59 - minutos) * 60 + (60 - segundos)) * 1000;

  console.log("⏳ Primer escaneo programado en:", (msRestantes / 1000 / 60).toFixed(2), "minutos");

  setTimeout(() => {
    cargarScanner();
    setInterval(() => {
      cargarScanner();
    }, 3600000); // cada hora
  }, msRestantes);
}

// 🚀 Iniciar al cargar
window.addEventListener("load", () => {
  cargarScanner(); // Primer escaneo manual
  iniciarScannerPorVela();
  if (Notification.permission !== "granted") {
    Notification.requestPermission();
  }
});

function num(x) { return x !== null && x !== undefined && x !== ""; }
function fmt(n) { return Number(n).toLocaleString(undefined, { maximumFractionDigits: 6 }); }
function escapeHTML(str) {
  if (!str) return "";
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
</script>
</body>
</html>

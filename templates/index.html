<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Crypto Signals Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        h1 { text-align: center; margin-bottom: 20px; }
        table { width: 80%; margin: auto; border-collapse: collapse; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        th, td { padding: 12px 15px; text-align: center; border-bottom: 1px solid #ddd; }
        th { background-color: #333; color: white; }
        tr:hover { background-color: #f1f1f1; }
        .signal-buy { color: #27ae60; font-weight: bold; }
        .signal-sell { color: #c0392b; font-weight: bold; }
        .signal-hold { color: #7f8c8d; font-weight: bold; }
        .prob-bar { height: 16px; border-radius: 8px; background: #ddd; margin: auto; position: relative; width: 80%; }
        .prob-fill { height: 100%; border-radius: 8px; text-align: center; color: white; font-size: 12px; line-height: 16px; }
        #updateBtn { display: block; margin: 20px auto; padding: 10px 25px; font-size: 16px; cursor: pointer; background-color: #3498db; color: white; border: none; border-radius: 5px; }
        #updateBtn:hover { background-color: #2980b9; }
        #lastUpdate { text-align: center; margin-top: 10px; font-size: 14px; color: #555; }
        #errorMsg { text-align: center; color: #c0392b; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Crypto Signals Dashboard</h1>
    <button id="updateBtn">Actualizar Ahora</button>
    <table>
        <thead>
            <tr>
                <th>Símbolo</th>
                <th>Señal</th>
                <th>Probabilidad</th>
            </tr>
        </thead>
        <tbody id="signalsTable">
            <tr><td colspan="3">Cargando...</td></tr>
        </tbody>
    </table>
    <div id="lastUpdate"></div>
    <div id="errorMsg"></div>

    <script>
        const API_URL = "/api/signals";  // ruta relativa a Flask
        const REFRESH_INTERVAL = 30 * 1000; // 30 segundos

        async function fetchSignals() {
            const tableBody = document.getElementById("signalsTable");
            const errorDiv = document.getElementById("errorMsg");
            tableBody.innerHTML = "<tr><td colspan='3'>Cargando...</td></tr>";
            errorDiv.textContent = "";

            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();

                if (!Array.isArray(data) || data.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='3'>⚠️ No hay señales disponibles</td></tr>";
                    return;
                }

                tableBody.innerHTML = "";
                data.forEach(item => {
                    const tr = document.createElement("tr");

                    // Color de fila según señal
                    if ((item.signal || "").includes("Comprar")) tr.style.backgroundColor = "#e8f8f5";
                    else if ((item.signal || "").includes("Vender")) tr.style.backgroundColor = "#fdecea";
                    else tr.style.backgroundColor = "#f0f0f0";

                    // Símbolo
                    const tdSymbol = document.createElement("td");
                    tdSymbol.textContent = item.symbol || "N/A";

                    // Señal
                    const tdSignal = document.createElement("td");
                    tdSignal.textContent = item.signal || "N/A";
                    if ((item.signal || "").includes("Comprar")) tdSignal.className = "signal-buy";
                    else if ((item.signal || "").includes("Vender")) tdSignal.className = "signal-sell";
                    else tdSignal.className = "signal-hold";

                    // Probabilidad
                    const tdProb = document.createElement("td");
                    const probValue = item.prob_up ?? item.prob ?? 0;
                    const barContainer = document.createElement("div");
                    barContainer.className = "prob-bar";

                    const barFill = document.createElement("div");
                    barFill.className = "prob-fill";
                    barFill.style.width = `${probValue * 100}%`;

                    if (probValue >= 0.75) barFill.style.backgroundColor = "#27ae60";
                    else if (probValue <= 0.05) barFill.style.backgroundColor = "#c0392b";
                    else barFill.style.backgroundColor = "#7f8c8d";

                    barFill.textContent = `${(probValue*100).toFixed(1)}%`;

                    barContainer.appendChild(barFill);
                    tdProb.appendChild(barContainer);

                    tr.appendChild(tdSymbol);
                    tr.appendChild(tdSignal);
                    tr.appendChild(tdProb);

                    tableBody.appendChild(tr);
                });

                const now = new Date();
                document.getElementById("lastUpdate").textContent = `Última actualización: ${now.toLocaleTimeString()}`;

            } catch (error) {
                tableBody.innerHTML = "<tr><td colspan='3'>❌ Error de conexión o datos inválidos</td></tr>";
                errorDiv.textContent = `Detalles del error: ${error.message}`;
                console.error("Error al obtener señales:", error);
            }
        }

        fetchSignals();
        document.getElementById("updateBtn").addEventListener("click", fetchSignals);
        setInterval(fetchSignals, REFRESH_INTERVAL);
    </script>
</body>
</html>

